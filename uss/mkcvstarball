#!/bin/bash

# temporary modified files
TMPMOD="configure.in ChangeLog"

# preserve
for TM in ${TMPMOD}
do
  cp -p ${TM} ${TM}.tm
done

if [ "x${1}" != "x" ]
then
  # it is a prerelease
  # modify them
  ( date -R; echo "This is prelease ${1}"; echo; cat ChangeLog.tm ) > ChangeLog
  sed -e "s/^AC_INIT(\(.*\), \(.*\))/AC_INIT(\1, \2pre${1})/" \
      -e "/doc\/reference/d" \
    configure.in.tm > configure.in
else
  sed -e "/doc\/reference/d" \
    configure.in.tm > configure.in
fi

# make the tarball and check it
./autogen.sh
GCONF_DISABLE_MAKEFILE_SCHEMA_INSTALL=yes make distcheck
if [ $? -ne 0 ]
then
 echo make distcheck failed
 exit 1
fi

# restore the temporary modified files
for TM in ${TMPMOD}
do
  mv ${TM}.tm ${TM}
done

# show the MD5 checksum of the fresh tarball
md5sum $( ls -t *.tar.gz | head -1 )

# eof

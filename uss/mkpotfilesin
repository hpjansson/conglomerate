#!/bin/bash
# $Id$
VERSION=$( echo '$Revision$' | awk '{ print $2 }' )
#
# po strings update
#
# makes po/POTFILES.in
#
# GPL (c) 2004 Geert Stappers  <stappers@stappers.nl>
#

# po.sible effected files
PPI=po/POTFILES.in
PCL=po/ChangeLog

# fresh files
FPPI=${PPI}.fresh
FPCL=${PCL}.fresh
# 

# header
cat << HERE > ${FPPI}
# Generated by upstream script uss/mkpotfilesin
# Use that script
# because 'intltool-update' doesn't know about display spec files
[encoding: UTF-8]
HERE

# display spec files
find dispspecs -name "*.xds.in" -printf "[type: gettext/xml]%p\n" | sort >> ${FPPI}

# core of this script is creating 'po/missing'
# with an empty po/POTFILES.in
cp -p ${PPI} ${PPI}.copy
> ${PPI}
( cd po ; intltool-update --maintain 2> /dev/null )
mv ${PPI}.copy ${PPI}


# mayby other enumerated files
## echo foo >> ${FPPI}
## echo bar >> ${FPPI}


# glue together
cat po/missing ${FPPI} > ${FPPI}.unsorted

sort ${FPPI}.unsorted > ${FPPI}

# tailer
echo "# end of file" >> ${FPPI}
 
 
function make_fresh_po_ChangeLog
{
 #date +"%F  mkpotfiles runner  <@>" > ${FPCL}
  date +"%F  Geert Stappers  <stappers@stappers.nl>" > ${FPCL}
  echo >> ${FPCL}
  echo -e "\t* POTFILES.in:" >> ${FPCL}
  echo -e "\tRegenerated, with uss/mkpotfilesin version ${VERSION}," >> ${FPCL}
  echo -e "\tthis will effect the .po files." >> ${FPCL}
  echo >> ${FPCL}
  cat ${PCL} >> ${FPCL}
}

# Okay, we have the fresh file, but do we need to do more
if [ $( diff ${PPI} ${FPPI} | wc -l ) -gt 0 ]
then
	# use the fresh POTFILES.in
	mv ${FPPI} ${PPI}
	# update ChangeLog
	make_fresh_po_ChangeLog
	mv ${FPCL} ${PCL}
	# ask user for help
	echo update the name in po/ChangeLog
	echo and do 
	echo  cvs commit -m\"po/ updated with $0\" po
else
	: # kiep kwijt  ;-)
fi

# cleanup
rm -f ${FPPI} ${FPPI}.unsorted ${FPCL}

# end of script
